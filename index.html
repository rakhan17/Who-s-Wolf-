<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Who's Wolf ‚Äî Enhanced</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê∫</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1220; --muted:#9ca3af; --card:rgba(255,255,255,0.02); --border:rgba(148,163,184,0.08); }
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:'Poppins',system-ui,Segoe UI,Roboto; overflow: hidden;}
    
    .screen{display:flex; align-items:center; justify-content:center; position:absolute; inset:0; padding:16px; box-sizing:border-box; opacity:0; transition:opacity 0.4s ease-in-out; pointer-events:none;}
    .screen.active{ opacity:1; pointer-events:auto; }

    .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));border-radius:14px;padding:24px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .muted{color:var(--muted)}
    .input-wrapper{position:relative;width:100%;}
    .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#94a3b8}
    input.input-field{width:100%;padding:12px 14px;border-radius:12px;background:transparent;border:1px solid var(--border);color:#e6eef8;outline:none}
    input.input-field.has-icon { padding-left: 44px; }
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:.7rem 1rem;border-radius:12px;font-weight:700;cursor:pointer;border:0; transition: all 0.2s ease;}
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(90deg,#7c3aed,#4f46e5);color:white}
    .btn-secondary{background:#1f2937;color:#cbd5e1}
    .btn-danger{background:linear-gradient(90deg,#ef4444,#b91c1c);color:white}
    .btn-green{background:linear-gradient(90deg,#10b981,#06b6d4);color:white}
    .spinner{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.2);border-top-color:white;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:50; opacity: 0; transition: opacity 0.3s ease; pointer-events:none;}
    .modal{min-width:280px;max-width:420px; opacity: 0; transform: scale(0.95); transition: all 0.3s ease;}
    .modal-backdrop.active { opacity: 1; pointer-events:auto; }
    .modal-backdrop.active .modal { opacity: 1; transform: scale(1); }

    #notification-toast {position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 10px; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none;}
    #notification-toast.show { opacity: 1; top: 30px; }
    
    .screen * { box-sizing:border-box }
    .hidden { display: none !important; }

    .shimmer-tag { font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 5px; color: white; background: linear-gradient(270deg, #ff2d2d, #ff7b7b, #ff2d2d); background-size: 200% 200%; animation: shimmer 2s ease infinite; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* Custom Checkbox Styles */
    .toggle-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 100%; }
    .toggle-label input { display: none; }
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; background-color: rgba(255,255,255,0.1); border-radius: 22px; transition: background-color 0.2s; }
    .toggle-switch::after { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.2s; }
    .toggle-label input:checked + .toggle-switch { background-color: #4f46e5; }
    .toggle-label input:checked + .toggle-switch::after { transform: translateX(18px); }
  </style>
</head>
<body>
  <!-- Notification Toast -->
  <div id="notification-toast"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="screen active" style="background:linear-gradient(180deg, rgba(2,6,23,0.8), rgba(2,6,23,0.95));z-index:40">
    <div style="text-align:center">
      <div style="font-size:56px">üê∫</div>
      <h1 style="font-size:26px;margin:6px 0; color:white;">Who's Wolf?</h1>
      <div class="spinner" style="width:32px; height:32px; border-width:3px; margin: 20px auto 12px auto;"></div>
      <div class="muted">Connecting...</div>
    </div>
  </div>

  <!-- NICKNAME screen -->
  <div id="nickname-screen" class="screen" style="z-index:10">
    <div class="card" style="width:100%;max-width:420px;text-align:center">
      <div style="font-size:56px">üê∫</div>
      <h1 style="font-size:26px;margin:6px 0">Welcome!</h1>
      <p class="muted">Enter your nickname to play</p>
      <div style="margin-top:16px;">
        <div class="input-wrapper" style="margin-bottom:12px"><span class="input-icon">üôç</span><input id="nickname-input" class="input-field has-icon" placeholder="Your Nickname" maxlength="25"></div>
        <button id="btn-enter-lobby" class="btn btn-primary" style="width:100%">Enter Lobby</button>
      </div>
    </div>
  </div>

  <!-- LOBBY screen -->
  <div id="lobby-screen" class="screen" style="z-index:15">
    <div class="card" style="width:100%;max-width:900px">
      <!-- Header -->
      <div style="display:flex;justify-content:space-between;align-items:center; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-size:32px">üê∫</div>
            <h2 style="margin:0; font-size:22px;">Who's Wolf?</h2>
        </div>
        <div style="display:flex; align-items:center; gap:16px;">
          <div id="welcome-container" style="text-align:right;">
            <div class="flex items-center gap-2">
              <h2 id="welcome-text" style="margin:0; font-size:18px;">Welcome</h2>
              <button id="btn-edit-name" class="text-sm">‚úèÔ∏è</button>
            </div>
            <p class="muted" id="welcome-sub" style="margin:0; font-size:12px;">Ready to hunt?</p>
          </div>
          <button id="btn-how-to-play" class="btn btn-secondary">How to Play</button>
        </div>
      </div>

      <!-- Pre-Room View -->
      <div id="pre-room-view" style="margin-top:24px; display:flex; flex-direction:column; align-items:center; gap: 24px;">
        <div style="text-align:center; width:100%; max-width:320px;">
          <h3 style="margin-top:0; margin-bottom:12px; font-weight:600;">Create a New Room</h3>
          <button id="btn-create-room" class="btn btn-primary" style="width:100%;">Create Room</button>
        </div>
        <div style="display:flex; align-items:center; gap:12px; width:100%; max-width: 320px; color: var(--muted);">
          <hr style="flex:1; border:0; border-top: 1px solid var(--border);"><span class="text-sm">OR</span><hr style="flex:1; border:0; border-top: 1px solid var(--border);">
        </div>
        <div style="text-align:center; width:100%; max-width:320px;">
          <h3 style="margin-top:0; margin-bottom:12px; font-weight:600;">Join an Existing Room</h3>
          <div style="display:flex;gap:8px;">
            <input id="join-code" class="input-field" placeholder="ROOM CODE" style="flex:1; text-transform:uppercase;"/>
            <button id="btn-join" class="btn btn-green">Join</button>
          </div>
        </div>
      </div>

      <!-- In-Room View -->
      <div id="in-room-view" class="hidden" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0">Room Code: <span id="room-code-display" style="color:#7c3aed; font-weight:700; cursor:pointer;"></span></h3>
            <button id="btn-leave" class="btn btn-secondary">Leave Room</button>
        </div>
        <div style="display:flex;gap:16px">
          <!-- Player List -->
          <div style="flex:1">
            <h4 style="margin:0 0 8px 0">Players (<span id="player-count">0</span>)</h4>
            <div id="player-list" style="min-height:220px;max-height:220px;overflow:auto;border-radius:10px;padding:8px;background:rgba(255,255,255,0.01)"></div>
          </div>
          <!-- Room Settings (Host only) -->
          <div id="room-settings-panel" style="width:360px">
            <div class="card" style="padding:16px">
              <h3 style="margin:0 0 12px 0">Room Settings</h3>
              <div class="space-y-3">
                <div>
                  <label class="muted text-sm">Werewolves</label>
                  <input id="setting-wolves" type="number" min="1" value="1" class="input-field setting-input w-full mt-1"/>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                  <label class="toggle-label muted">Seer <input id="setting-seer" type="checkbox" checked class="setting-input"><span class="toggle-switch"></span></label>
                  <label class="toggle-label muted">Doctor <input id="setting-doctor" type="checkbox" checked class="setting-input"><span class="toggle-switch"></span></label>
                  <label class="toggle-label muted">Hunter <input id="setting-hunter" type="checkbox" class="setting-input"><span class="toggle-switch"></span></label>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-2">
                  <div>
                    <label class="muted text-sm">Day (s)</label>
                    <input id="setting-day" type="number" value="60" class="input-field setting-input w-full mt-1"/>
                  </div>
                  <div>
                    <label class="muted text-sm">Night (s)</label>
                    <input id="setting-night" type="number" value="45" class="input-field setting-input w-full mt-1"/>
                  </div>
                </div>
              </div>
            </div>
             <button id="btn-start" class="btn btn-primary hidden" style="width:100%; margin-top:12px;">Start Game</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GAME screen -->
  <div id="game-screen" class="screen" style="z-index:20; display:flex; flex-direction:column; gap:16px; padding:16px;">
    <!-- Game Header -->
    <div class="card" style="width:100%; padding:12px 24px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h2 id="game-phase-title" style="margin:0; font-size:22px;">Night 1</h2>
        <p id="game-phase-subtitle" class="muted" style="margin:0; font-size:14px;">The village is asleep...</p>
      </div>
      <div style="text-align:center;">
        <div id="game-timer" style="font-size:28px; font-weight:700;">00:45</div>
        <div class="muted" style="font-size:12px;">TIME REMAINING</div>
      </div>
    </div>

    <!-- Main Game Area -->
    <div style="width:100%; flex:1; display:flex; gap:16px; overflow:hidden;">
      <!-- Left Panel (Players & Dev Tools) -->
      <div style="display:flex; flex-direction:column; gap:16px; width:280px;">
        <div class="card" style="padding:16px; flex:1; display:flex; flex-direction:column;">
          <h3 style="margin:0 0 8px 0;">Players</h3>
          <div id="game-player-list" style="overflow-y:auto; flex:1;"></div>
        </div>
        <div id="developer-panel" class="card hidden" style="padding:16px;">
          <h4 style="margin:0 0 8px 0; color:#ff5555;">Developer Tools</h4>
          <p class="muted text-xs">Use with caution!</p>
          <button id="dev-end-game" class="btn btn-secondary w-full text-xs">End Game</button>
        </div>
      </div>

      <!-- Center Panel (Main content) -->
      <div id="game-main-content" class="card" style="padding:16px; flex:1; overflow-y: auto;">
        <!-- Player cards will be dynamically inserted here -->
      </div>

      <!-- Right Panel (Chat) -->
      <div class="card" style="padding:16px; width:320px; display:flex; flex-direction:column;">
        <h3 style="margin:0 0 8px 0;">Global Chat</h3>
        <div id="chat-messages" style="flex:1; overflow-y:auto; margin-bottom:8px; font-size:14px;"></div>
        <div style="display:flex; gap:8px;">
          <input id="chat-input" class="input-field" style="flex:1;" placeholder="Type a message..." disabled/>
          <button id="chat-send" class="btn btn-primary" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Role Reveal Modal -->
  <div id="role-reveal-modal" class="modal-backdrop">
    <div class="modal card" style="text-align:center;">
      <div id="role-reveal-emoji" style="font-size:80px; margin-bottom:12px;"></div>
      <h1 id="role-reveal-name" style="font-size:28px; margin:0;"></h1>
      <p id="role-reveal-description" class="muted" style="margin-top:8px;"></p>
      <div id="role-reveal-allies" class="mt-4"></div>
      <button id="btn-close-role-reveal" class="btn btn-primary" style="width:100%; margin-top:24px;">Continue</button>
    </div>
  </div>
  
  <!-- Seer Result Modal -->
  <div id="seer-result-modal" class="modal-backdrop">
    <div class="modal card" style="text-align:center;">
        <h1 id="seer-result-title" style="font-size:28px; margin:0;">Seer's Vision</h1>
        <p id="seer-result-body" class="muted" style="margin-top:16px;"></p>
        <button onclick="showModal('seer-result-modal', false)" class="btn btn-primary w-full mt-4">Close</button>
    </div>
  </div>

  <!-- Event Announcement Modal -->
  <div id="event-modal" class="modal-backdrop">
    <div class="modal card" style="text-align:center;">
        <h1 id="event-title" style="font-size:28px; margin:0;"></h1>
        <div id="event-body" class="muted" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="game-over-modal" class="modal-backdrop">
    <div class="modal card" style="text-align:center;">
      <h1 id="game-over-title" style="font-size:28px; margin:0;"></h1>
      <p id="game-over-reason" class="muted" style="margin-top:8px;"></p>
      <div id="game-over-roles" style="margin-top:16px; text-align:left;"></div>
      <button id="btn-back-to-lobby" class="btn btn-primary" style="width:100%; margin-top:24px;">Back to Lobby</button>
    </div>
  </div>

  <!-- How to Play Modal -->
  <div id="rules-modal-backdrop" class="modal-backdrop">
    <div class="modal card">
        <h2 style="margin-top:0">How to Play Who's Wolf</h2>
        <p class="muted">The game is divided into two phases: Night and Day. The goal of the Villagers is to eliminate all Werewolves. The goal of the Werewolves is to outnumber the Villagers.</p>
        <h3 style="margin-bottom:8px;">Roles</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div><strong>üê∫ Werewolf</strong><p class="muted" style="font-size:14px;">During the night, wake up with fellow werewolves to choose one player to eliminate.</p></div>
            <div><strong>üë± Villager</strong><p class="muted" style="font-size:14px;">During the day, discuss and vote to eliminate a player you suspect is a werewolf.</p></div>
            <div><strong>üëÅÔ∏è Seer</strong><p class="muted" style="font-size:14px;">During the night, you can choose one player to learn their true identity (Werewolf or not).</p></div>
            <div><strong>üßë‚Äç‚öïÔ∏è Doctor</strong><p class="muted" style="font-size:14px;">During the night, you can choose one player to protect from a werewolf attack for that night.</p></div>
            <div><strong>üéØ Hunter</strong><p class="muted" style="font-size:14px;">You have one bullet. At night, you can choose to shoot a player you think is a werewolf.</p></div>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button id="btn-close-rules" class="btn btn-primary">Got it!</button>
        </div>
    </div>
  </div>

  <script type="module">
    // ---------- Eager Firebase Imports ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, collection, setDoc, getDoc, runTransaction, onSnapshot, deleteField, updateDoc, deleteDoc, serverTimestamp, query, orderBy, addDoc, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ---------- UI Helpers ----------
    const screens = document.querySelectorAll('.screen');
    function showScreen(id){ screens.forEach(s => s.classList.toggle('active', s.id === id)); }
    const loadingOverlay = document.getElementById('loading-overlay');
    function setLoading(on){ loadingOverlay.classList.toggle('active', on); }
    function showToast(msg, err=false){
      const t = document.getElementById('notification-toast');
      t.textContent = msg;
      t.style.background = err ? 'linear-gradient(90deg,#ef4444,#f97316)' : 'linear-gradient(90deg,#10b981,#06b6d4)';
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 3000);
    }
    window.showModal = (id, show) => { // Make it global for inline onclick
        document.getElementById(id)?.classList.toggle('active', show);
    }

    // ---------- Firebase Initialization ----------
    let auth, db;
    const firebaseConfig = {
      apiKey: "AIzaSyCsPjYivo2bQp-fsr5wcdBfTRIiAcSbJNo",
      authDomain: "who-s-wolf.firebaseapp.com",
      projectId: "who-s-wolf",
      storageBucket: "who-s-wolf.appspot.com",
      messagingSenderId: "981640498887",
      appId: "1:981640498887:web:92e582b23c6588d48a78e2",
    };

    function initializeFirebase() {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            handleAuthentication();
        } catch(e) {
            console.error("Firebase Init Error:", e);
            showToast('Failed to initialize application.', true);
        }
    }

    // ---------- Auth & User Profile Logic ----------
    let currentUser = null;
    const DEV_PREFIX = "[slnana]";
    
    async function handleAuthentication() {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const isDev = user.displayName?.toLowerCase().startsWith(DEV_PREFIX) || false;
                currentUser = { 
                    uid: user.uid, 
                    displayName: user.displayName,
                    isDeveloper: isDev
                };
                if (user.displayName) {
                    updateWelcomeText(user.displayName);
                    showScreen('lobby-screen');
                } else {
                    showScreen('nickname-screen');
                }
                setLoading(false);
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous Sign In Error:", error);
                    showToast('Failed to connect to server.', true);
                }
            }
        });
    }
    
    function updateWelcomeText(name) {
        const isDev = name.toLowerCase().startsWith(DEV_PREFIX);
        const displayName = isDev ? name.substring(DEV_PREFIX.length).trim() : name;
        const welcomeTextEl = document.getElementById('welcome-text');
        welcomeTextEl.textContent = displayName;
        if (isDev) {
            const devTag = document.createElement('span');
            devTag.className = 'shimmer-tag ml-2';
            devTag.textContent = 'Developer';
            welcomeTextEl.appendChild(devTag);
        }
    }

    async function setNickname(nickname) {
        if (!nickname) {
            showToast('Nickname cannot be empty!', true);
            return false;
        }
        setLoading(true);
        try {
            await updateProfile(auth.currentUser, { displayName: nickname });
            currentUser.displayName = nickname;
            currentUser.isDeveloper = nickname.toLowerCase().startsWith(DEV_PREFIX);
            updateWelcomeText(nickname);
            showScreen('lobby-screen');
            return true;
        } catch (error) {
            console.error("Update Profile Error:", error);
            showToast('Failed to save nickname.', true);
            return false;
        } finally {
            setLoading(false);
        }
    }

    document.getElementById('btn-enter-lobby').addEventListener('click', () => {
        setNickname(document.getElementById('nickname-input').value.trim());
    });

    document.getElementById('btn-edit-name').addEventListener('click', () => {
        const newName = prompt("Enter new nickname:", currentUser.displayName);
        if (newName) setNickname(newName.trim());
    });


    // ---------- Room Flow & Logic ----------
    let currentRoomId = null;
    let roomUnsub = null;
    let chatUnsub = null;
    let gameTimerInterval = null;
    let presenceInterval = null;
    let localGameState = {}; // To store local data like target roles for Seer

    function setLobbyView(inRoom) {
        document.getElementById('pre-room-view').classList.toggle('hidden', inRoom);
        document.getElementById('in-room-view').classList.toggle('hidden', !inRoom);
    }
    
    function startPresenceUpdates() {
        if (presenceInterval) clearInterval(presenceInterval);
        presenceInterval = setInterval(async () => {
            if (currentRoomId && currentUser && db) {
                const roomRef = doc(db, 'rooms', currentRoomId);
                try {
                    await updateDoc(roomRef, {
                        [`players.${currentUser.uid}.lastSeen`]: serverTimestamp()
                    });
                } catch (e) { /* Fail silently */ }
            }
        }, 15000);
    }

    function stopPresenceUpdates() {
        if (presenceInterval) clearInterval(presenceInterval);
        presenceInterval = null;
    }

    async function createRoom(){
      setLoading(true);
      try {
        const code = Math.random().toString(36).substring(2,8).toUpperCase();
        const roomRef = doc(db, 'rooms', code);
        
        const hostData = { 
            nickname: currentUser.displayName, 
            isHost: true,
            isDeveloper: currentUser.isDeveloper,
            lastSeen: serverTimestamp()
        };
        
        await setDoc(roomRef, { 
            hostId: currentUser.uid, 
            players: { [currentUser.uid]: hostData }, 
            settings: getSettingsFromUI(), 
            state: 'lobby',
            createdAt: serverTimestamp()
        });
        
        currentRoomId = code;
        try { window.history.replaceState({}, '', '?room=' + code); } catch (e) { console.warn("Could not update URL:", e); }
        subscribeToRoom(code);
        showToast('Room created: ' + code);

      } catch(e){
        console.error("Create Room Error:", e);
        showToast('Failed to create room. Check Firestore rules.', true);
      } finally {
        setLoading(false);
      }
    }

    async function joinRoom(code){
      setLoading(true);
      try {
        const roomRef = doc(db, "rooms", code);
        await runTransaction(db, async (transaction) => {
            const roomDoc = await transaction.get(roomRef);
            if (!roomDoc.exists()) throw new Error("Room not found!");
            const roomData = roomDoc.data();
            if (roomData.state !== 'lobby') throw new Error("Game has already started!");
            
            const newPlayerData = {
                nickname: currentUser.displayName,
                isHost: false,
                isDeveloper: currentUser.isDeveloper,
                lastSeen: serverTimestamp()
            };
            transaction.update(roomRef, { [`players.${currentUser.uid}`]: newPlayerData });
        });

        currentRoomId = code;
        try { window.history.replaceState({}, '', '?room=' + code); } catch (e) { console.warn("Could not update URL:", e); }
        subscribeToRoom(code);
        showToast('Joined ' + code);
      } catch (error) {
          console.error("Join Room Error:", error);
          showToast(`Failed to join: ${error.message}`, true);
      } finally {
          setLoading(false);
      }
    }

    function subscribeToRoom(code){
      if(roomUnsub) roomUnsub();
      startPresenceUpdates();
      const roomRef = doc(db, 'rooms', code);
      roomUnsub = onSnapshot(roomRef, snap => {
        if(!snap.exists()){
          showToast('Room closed by host.', true);
          handleRoomClose();
          return;
        }
        const roomData = snap.data();
        localGameState = roomData; // Store latest game state locally
        
        if (roomData.hostId === currentUser.uid && roomData.state !== 'lobby') {
            hostGameLogic(roomData);
        }

        if (roomData.state === 'lobby' && !roomData.players[currentUser.uid]) {
            showToast("You were kicked from the room.", true);
            handleRoomClose();
            return;
        }

        switch(roomData.state) {
            case 'lobby': showScreen('lobby-screen'); renderLobbyView(roomData); break;
            case 'role_reveal': showScreen('game-screen'); renderRoleReveal(roomData); break;
            case 'announcement': showScreen('game-screen'); renderAnnouncement(roomData); break;
            case 'night': case 'day': showScreen('game-screen'); renderGamePhase(roomData); break;
            case 'game_over': showScreen('game-screen'); renderGameOver(roomData); break;
        }
      }, err => {
        console.error("Room subscription error:", err);
        showToast('Connection to room lost.', true);
        handleRoomClose();
      });
      subscribeToChat(code);
    }
    
    function subscribeToChat(code) {
        if (chatUnsub) chatUnsub();
        const chatRef = collection(db, 'rooms', code, 'messages');
        const q = query(chatRef, orderBy('timestamp', 'asc'));
        chatUnsub = onSnapshot(q, (snapshot) => {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const msgEl = document.createElement('div');
                
                const isDev = msg.isDeveloper;
                const displayName = isDev ? msg.nickname.substring(DEV_PREFIX.length).trim() : msg.nickname;

                let nickHTML = `<strong>${displayName}</strong>`;
                if(isDev) {
                    nickHTML += ` <span class="shimmer-tag ml-2">Developer</span>`;
                }

                msgEl.innerHTML = `<p class="mb-1">${nickHTML}: ${msg.text}</p>`;
                chatMessages.appendChild(msgEl);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    async function leaveRoom(){
      if(currentRoomId){
        const roomRef = doc(db, "rooms", currentRoomId);
        try {
            const roomDoc = await getDoc(roomRef);
            if (roomDoc.exists()) {
                const roomData = roomDoc.data();
                const isHost = roomData.hostId === currentUser.uid;
                if (isHost || Object.keys(roomData.players).length <= 1) {
                    await deleteDoc(roomRef);
                } else {
                    await updateDoc(roomRef, { [`players.${currentUser.uid}`]: deleteField() });
                }
            }
        } catch(e){ console.error('Leave Room Error:', e); }
      }
      handleRoomClose();
    }
    
    function handleRoomClose() {
        if(roomUnsub){ roomUnsub(); roomUnsub = null; }
        if(chatUnsub){ chatUnsub(); chatUnsub = null; }
        stopPresenceUpdates();
        currentRoomId = null;
        if(gameTimerInterval) clearInterval(gameTimerInterval);
        try { window.history.replaceState({}, '', location.pathname); } catch (e) { console.warn("Could not update URL:", e); }
        setLobbyView(false);
        showScreen('lobby-screen');
    }
    
    async function kickPlayer(playerIdToKick) {
        if (!currentRoomId) return;
        const roomRef = doc(db, "rooms", currentRoomId);
        try {
            await updateDoc(roomRef, {
                [`players.${playerIdToKick}`]: deleteField()
            });
            showToast("Player kicked successfully.");
        } catch (e) {
            console.error("Kick Player Error:", e);
            showToast("Failed to kick player.", true);
        }
    }

    function renderLobbyView(roomData){
      setLobbyView(true);
      const codeDisplay = document.getElementById('room-code-display');
      codeDisplay.textContent = currentRoomId || '----';
      codeDisplay.onclick = () => {
          const tempInput = document.createElement('input');
          document.body.appendChild(tempInput);
          tempInput.value = currentRoomId;
          tempInput.select();
          try {
              document.execCommand('copy');
              showToast('Room code copied!');
          } catch (err) {
              showToast('Failed to copy code.', true);
          }
          document.body.removeChild(tempInput);
      };

      const list = document.getElementById('player-list');
      list.innerHTML = '';
      const players = roomData.players || {};
      const playerIds = Object.keys(players);
      document.getElementById('player-count').textContent = playerIds.length;
      
      const isCurrentUserHost = roomData.hostId === currentUser.uid;

      playerIds.forEach(pid => {
        const p = players[pid];
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center p-2 rounded-lg mb-2';
        
        const isDev = p.isDeveloper;
        const displayName = isDev ? p.nickname.substring(DEV_PREFIX.length).trim() : p.nickname;
        
        const isOnline = p.lastSeen && (Date.now() / 1000 - p.lastSeen.seconds < 30);
        let onlineIndicatorHTML = '';
        if (currentUser.isDeveloper && pid !== currentUser.uid) {
            const color = isOnline ? '#22c55e' : '#6b7280';
            onlineIndicatorHTML = `<span style="color: ${color}; font-size: 1.2em; margin-right: 8px;" title="${isOnline ? 'Online' : 'Offline'}">‚óè</span>`;
        }

        let nickHTML = `<strong>${displayName} ${p.isHost ? 'üëë' : ''}</strong>`;
        if(isDev) {
            nickHTML += ` <span class="shimmer-tag ml-2">Developer</span>`;
        }
        
        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = onlineIndicatorHTML + nickHTML;
        el.appendChild(nameDiv);

        const canBeKicked = pid !== currentUser.uid && !p.isHost;
        if ((isCurrentUserHost || currentUser.isDeveloper) && canBeKicked) {
            const kickBtn = document.createElement('button');
            kickBtn.textContent = 'Kick';
            kickBtn.className = 'btn btn-danger text-xs px-2 py-1';
            kickBtn.onclick = () => {
                if(confirm(`Are you sure you want to kick ${displayName}?`)) {
                    kickPlayer(pid);
                }
            };
            el.appendChild(kickBtn);
        }
        
        list.appendChild(el);
      });

      document.getElementById('room-settings-panel').style.display = isCurrentUserHost ? 'block' : 'none';
      document.getElementById('btn-start').classList.toggle('hidden', !isCurrentUserHost || playerIds.length < 3);
      
      updateSettingsUI(roomData.settings, !isCurrentUserHost);
    }
    
    // ---------- Settings Management ----------
    function getSettingsFromUI() {
        return {
            numWerewolves: parseInt(document.getElementById('setting-wolves').value || 1),
            includeSeer: document.getElementById('setting-seer').checked,
            includeDoctor: document.getElementById('setting-doctor').checked,
            includeHunter: document.getElementById('setting-hunter').checked,
            dayDuration: parseInt(document.getElementById('setting-day').value || 60),
            nightDuration: parseInt(document.getElementById('setting-night').value || 45)
        };
    }
    function updateSettingsUI(settings, disableInputs) {
        if (!settings) return;
        document.getElementById('setting-wolves').value = settings.numWerewolves;
        document.getElementById('setting-seer').checked = settings.includeSeer;
        document.getElementById('setting-doctor').checked = settings.includeDoctor;
        document.getElementById('setting-hunter').checked = settings.includeHunter;
        document.getElementById('setting-day').value = settings.dayDuration;
        document.getElementById('setting-night').value = settings.nightDuration;
        document.querySelectorAll('.setting-input').forEach(input => input.disabled = disableInputs);
    }
    
    async function updateSettingsInDb() {
        if (!currentRoomId || !currentUser.uid) return;
        const roomRef = doc(db,'rooms', currentRoomId);
        try {
            const snap = await getDoc(roomRef);
            if (snap.exists() && snap.data().hostId === currentUser.uid) {
                await updateDoc(roomRef, { settings: getSettingsFromUI() });
            }
        } catch (e) {
            console.error("Update Settings Error:", e);
            showToast("Failed to save settings.", true);
        }
    }

    // ---------- GAME LOGIC ----------

    async function hostGameLogic(roomData) {
        const roomRef = doc(db, 'rooms', currentRoomId);
        const { state, players, phaseEndTime } = roomData;

        if (state === 'role_reveal') {
            const allReady = Object.values(players).every(p => p.ready);
            if (allReady) {
                const endTime = Timestamp.fromMillis(Date.now() + roomData.settings.nightDuration * 1000);
                await updateDoc(roomRef, { state: 'night', phaseEndTime: endTime });
            }
            return;
        }

        if ((state === 'night' || state === 'day') && phaseEndTime && Timestamp.now().seconds > phaseEndTime.seconds) {
            setLoading(true);
            let nextState = {};
            if (state === 'night') {
                nextState = processNightActions(roomData);
            } else {
                nextState = processDayVotes(roomData);
            }
            
            const winState = checkWinCondition(nextState.players || players);
            if (winState) {
                await updateDoc(roomRef, { state: 'game_over', gameOver: winState });
            } else {
                await updateDoc(roomRef, nextState);
            }
            setLoading(false);
        }
    }
    
    function processNightActions(roomData) {
        let { players, turn, settings } = roomData;
        let events = [];
        const wolfVotes = {};
        let doctorSaveTarget = null;
        let hunterShotTarget = null;

        Object.entries(players).forEach(([pid, p]) => {
            if (p.isAlive && p.actionTarget) {
                if (p.role === 'werewolf') {
                    const target = p.actionTarget;
                    wolfVotes[target] = (wolfVotes[target] || 0) + 1;
                } else if (p.role === 'doctor') {
                    doctorSaveTarget = p.actionTarget;
                } else if (p.role === 'hunter' && !p.hasUsedAbility) {
                    hunterShotTarget = p.actionTarget;
                    players[pid].hasUsedAbility = true;
                }
            }
        });

        let killedByWolvesId = null;
        if (Object.keys(wolfVotes).length > 0) {
            killedByWolvesId = Object.keys(wolfVotes).reduce((a, b) => wolfVotes[a] > wolfVotes[b] ? a : b);
        }

        const deaths = new Set();
        if (killedByWolvesId && killedByWolvesId !== doctorSaveTarget) {
            deaths.add(killedByWolvesId);
        }
        if (hunterShotTarget && hunterShotTarget !== doctorSaveTarget) {
            deaths.add(hunterShotTarget);
        }

        if (deaths.size > 0) {
            deaths.forEach(pid => {
                players[pid].isAlive = false;
                events.push(`${players[pid].nickname} was found dead.`);
            });
        } else {
            events.push("The night was quiet... No one died.");
        }

        return {
            state: 'announcement',
            phase: 'day',
            players: players,
            announcement: { title: `Night ${turn} ended`, events: events },
        };
    }

    function processDayVotes(roomData) {
        let { players, turn } = roomData;
        let events = [];
        const votes = {};

        Object.values(players).forEach(p => {
            if (p.isAlive && p.votedFor) {
                votes[p.votedFor] = (votes[p.votedFor] || 0) + 1;
            }
        });

        let eliminatedPlayerId = null;
        let maxVotes = 0;
        let isTie = false;
        if (Object.keys(votes).length > 0) {
            for (const [pid, count] of Object.entries(votes)) {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedPlayerId = pid;
                    isTie = false;
                } else if (count === maxVotes) {
                    isTie = true;
                }
            }
        }

        if (isTie) eliminatedPlayerId = null;

        if (eliminatedPlayerId) {
            players[eliminatedPlayerId].isAlive = false;
            events.push(`${players[eliminatedPlayerId].nickname} was eliminated by popular vote. Their role was ${players[eliminatedPlayerId].role}.`);
        } else {
            events.push("The vote was tied. No one was eliminated.");
        }

        Object.keys(players).forEach(pid => {
            players[pid].actionTarget = null;
            players[pid].votedFor = null;
        });

        return {
            state: 'announcement',
            phase: 'night',
            turn: turn + 1,
            players: players,
            announcement: { title: `Day ${turn} ended`, events: events },
        };
    }

    function checkWinCondition(players) {
        const alivePlayers = Object.values(players).filter(p => p.isAlive);
        const aliveWolves = alivePlayers.filter(p => p.role === 'werewolf');
        const aliveVillagers = alivePlayers.filter(p => p.role !== 'werewolf');

        if (aliveWolves.length === 0) {
            return { winningTeam: "Villagers", reason: "All werewolves have been eliminated!", players };
        }
        if (aliveWolves.length >= aliveVillagers.length) {
            return { winningTeam: "Werewolves", reason: "The werewolves have taken over the village!", players };
        }
        return null;
    }


    async function startGame() {
        setLoading(true);
        const roomRef = doc(db, 'rooms', currentRoomId);
        try {
            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw new Error("Room not found.");
                const roomData = roomDoc.data();
                
                const playerIds = Object.keys(roomData.players);
                const settings = roomData.settings;

                let roles = [];
                for (let i = 0; i < settings.numWerewolves; i++) roles.push('werewolf');
                if (settings.includeSeer) roles.push('seer');
                if (settings.includeDoctor) roles.push('doctor');
                if (settings.includeHunter) roles.push('hunter');
                while (roles.length < playerIds.length) roles.push('villager');
                
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }

                const updatedPlayers = { ...roomData.players };
                playerIds.forEach((pid, index) => {
                    updatedPlayers[pid] = {
                        ...updatedPlayers[pid],
                        isAlive: true,
                        role: roles[index],
                        votedFor: null,
                        actionTarget: null,
                        ready: false,
                        hasUsedAbility: false, // For Hunter
                    };
                });

                transaction.update(roomRef, {
                    state: 'role_reveal',
                    players: updatedPlayers,
                    turn: 1,
                    phase: 'night',
                    events: [],
                    announcement: null
                });
            });
        } catch (e) {
            console.error("Start Game Error:", e);
            showToast("Failed to start game.", true);
        } finally {
            setLoading(false);
        }
    }
    
    function renderRoleReveal(roomData) {
        showScreen('game-screen');
        const myPlayerData = roomData.players[currentUser.uid];
        const roleInfo = {
            werewolf: { emoji: 'üê∫', desc: 'Each night, choose a player to eliminate with your pack.' },
            seer: { emoji: 'üëÅÔ∏è', desc: 'Each night, you may check one player to see their role.' },
            doctor: { emoji: 'üßë‚Äç‚öïÔ∏è', desc: 'Each night, you may choose one player to protect from attack.' },
            hunter: { emoji: 'üéØ', desc: 'You have one bullet. At night, you can choose to shoot a player you think is a werewolf.' },
            villager: { emoji: 'üë±', desc: 'Work with your fellow villagers to find and eliminate the werewolves.' },
        };

        document.getElementById('role-reveal-emoji').textContent = roleInfo[myPlayerData.role].emoji;
        document.getElementById('role-reveal-name').textContent = `You are a ${myPlayerData.role.charAt(0).toUpperCase() + myPlayerData.role.slice(1)}`;
        document.getElementById('role-reveal-description').textContent = roleInfo[myPlayerData.role].desc;
        
        const alliesDiv = document.getElementById('role-reveal-allies');
        if (myPlayerData.role === 'werewolf') {
            const allies = Object.values(roomData.players).filter(p => p.role === 'werewolf' && p.nickname !== myPlayerData.nickname);
            if(allies.length > 0) {
                const allyNames = allies.map(a => a.isDeveloper ? a.nickname.substring(DEV_PREFIX.length).trim() : a.nickname);
                alliesDiv.innerHTML = `<p class="muted">Your fellow werewolves are: <strong>${allyNames.join(', ')}</strong></p>`;
            } else {
                alliesDiv.innerHTML = `<p class="muted">You are the lone wolf...</p>`;
            }
        } else {
            alliesDiv.innerHTML = '';
        }

        showModal('role-reveal-modal', true);
    }

    function renderAnnouncement(roomData) {
        const { title, events } = roomData.announcement;
        document.getElementById('event-title').textContent = title;
        document.getElementById('event-body').innerHTML = events.map(e => `<p>${e}</p>`).join('');
        showModal('event-modal', true);

        setTimeout(async () => {
            showModal('event-modal', false);
            if (roomData.hostId === currentUser.uid) {
                const roomRef = doc(db, 'rooms', currentRoomId);
                const duration = roomData.phase === 'day' ? roomData.settings.dayDuration : roomData.settings.nightDuration;
                const endTime = Timestamp.fromMillis(Date.now() + duration * 1000);
                await updateDoc(roomRef, {
                    state: roomData.phase,
                    phaseEndTime: endTime,
                    announcement: null
                });
            }
        }, 4500);
    }
    
    function renderGamePhase(roomData) {
        renderGamePlayerList(roomData);
        renderPlayerCards(roomData);
        updateTimer(roomData.phaseEndTime);
        
        const myData = roomData.players[currentUser.uid];
        const isNight = roomData.phase === 'night';
        
        document.getElementById('game-phase-title').textContent = `${isNight ? 'Night' : 'Day'} ${roomData.turn}`;
        document.getElementById('game-phase-subtitle').textContent = isNight ? "Make your move..." : "Discuss and vote!";

        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const canChat = !isNight && myData.isAlive;
        chatInput.disabled = !canChat;
        chatSend.disabled = !canChat;
        chatInput.placeholder = canChat ? 'Type a message...' : 'Chat is disabled.';
    }
    
    function renderPlayerCards(roomData) {
        const mainContent = document.getElementById('game-main-content');
        mainContent.innerHTML = '';
        mainContent.style.display = 'grid';
        mainContent.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
        mainContent.style.gap = '16px';
        
        const myData = roomData.players[currentUser.uid];

        Object.entries(roomData.players).forEach(([pid, p]) => {
            const card = document.createElement('div');
            card.className = 'p-4 rounded-lg flex flex-col items-center justify-between text-center';
            card.style.background = 'rgba(255,255,255,0.02)';
            card.style.border = '2px solid transparent';
            card.style.aspectRatio = '1 / 1';

            const isMe = pid === currentUser.uid;
            const displayName = p.isDeveloper ? p.nickname.substring(DEV_PREFIX.length).trim() : p.nickname;

            let statusHTML = p.isAlive ? `<div class="text-4xl">üôÇ</div>` : `<div class="text-4xl">üëª</div>`;
            
            card.innerHTML = `
                <div>
                    ${statusHTML}
                    <strong class="mt-2">${displayName}</strong>
                    ${p.isDeveloper ? '<span class="shimmer-tag mt-1">Developer</span>' : ''}
                </div>
                <div class="flex gap-2 mt-3"></div>
            `;
            
            const actionsContainer = card.querySelector('.flex');
            const hasActed = !!myData.actionTarget;
            const canAct = myData.isAlive && p.isAlive && !isMe;
            
            const iconSVG = {
                kill: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M4.002 9.42a.5.5 0 0 1-.354-.146l-.853-.854a.5.5 0 1 1 .707-.708l.854.854a.5.5 0 0 1-.353.854m4.001.002a.5.5 0 0 1-.353-.146l-.854-.854a.5.5 0 1 1 .708-.708l.854.854a.5.5 0 0 1-.354.854m3.999-.001a.5.5 0 0 1-.353-.146l-.854-.854a.5.5 0 1 1 .708-.708l.853.854a.5.5 0 0 1-.354.854M8 13a4 4 0 0 1-2.93-1.332.5.5 0 0 1 .65-.75A3 3 0 0 0 8 12a3 3 0 0 0 2.28-1.082.5.5 0 0 1 .65.75A4 4 0 0 1 8 13"/></svg>`,
                seer: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/></svg>`,
                doctor: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5H2a.5.5 0 0 1 .5.5v4.5A1.5 1.5 0 0 0 4 14h8a1.5 1.5 0 0 0 1.5-1.5V8a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 0 .354-.854zM4.5 8.5A.5.5 0 0 1 5 8h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5m-.5 2.5A.5.5 0 0 1 4 10h8a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.5-.5"/></svg>`,
                hunter: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>`,
                revive: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M10.97 4.97a.237.237 0 0 0-.02-.022L7.477 1.477a.237.237 0 0 0-.022-.022.237.237 0 0 0-.022-.022A.235.235 0 0 0 7.15 1.4a.235.235 0 0 0-.215.022.237.237 0 0 0-.022.022.237.237 0 0 0-.022.022L3.03 4.97a.235.235 0 0 0 0 .33l.022.022.022.022.022.022a.235.235 0 0 0 .33 0l2.854-2.854V12a.235.235 0 0 0 .47 0V2.514l2.853 2.854a.235.235 0 0 0 .33 0l.022-.022.022-.022.022-.022a.235.235 0 0 0 0-.33"/></svg>`
            };
            
            if (roomData.phase === 'night') {
                if (currentUser.isDeveloper) {
                    if(p.isAlive && !isMe) {
                        actionsContainer.innerHTML += `<button title="Kill" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'kill')">${iconSVG.kill}</button>`;
                        actionsContainer.innerHTML += `<button title="See Role" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'seer')">${iconSVG.seer}</button>`;
                        actionsContainer.innerHTML += `<button title="Protect" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'doctor')">${iconSVG.doctor}</button>`;
                    } else if (!p.isAlive) {
                        actionsContainer.innerHTML += `<button title="Revive" class="btn btn-secondary p-2" onclick="dev_togglePlayerAlive('${pid}', true)">${iconSVG.revive}</button>`;
                    }
                } 
                else if (canAct && !hasActed) {
                    if (myData.role === 'werewolf') actionsContainer.innerHTML += `<button title="Kill" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'kill')">${iconSVG.kill}</button>`;
                    if (myData.role === 'seer') actionsContainer.innerHTML += `<button title="See Role" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'seer')">${iconSVG.seer}</button>`;
                    if (myData.role === 'doctor') actionsContainer.innerHTML += `<button title="Protect" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'doctor')">${iconSVG.doctor}</button>`;
                    if (myData.role === 'hunter' && !myData.hasUsedAbility) actionsContainer.innerHTML += `<button title="Shoot" class="btn btn-secondary p-2" onclick="performNightAction('${pid}', 'hunter')">${iconSVG.hunter}</button>`;
                }
            } else {
                if (myData.isAlive && p.isAlive && !isMe && !myData.votedFor) {
                    actionsContainer.innerHTML += `<button class="btn btn-primary px-4" onclick="voteForPlayer('${pid}')">Vote</button>`;
                }
            }
            
            if (!p.isAlive) card.style.opacity = '0.5';
            if (myData.actionTarget === pid || (typeof myData.actionTarget === 'object' && myData.actionTarget?.target === pid) || myData.votedFor === pid) {
                 card.style.border = '2px solid #ef4444';
            }

            mainContent.appendChild(card);
        });
    }


    function renderGamePlayerList(roomData) {
        const list = document.getElementById('game-player-list');
        list.innerHTML = '';
        const myData = roomData.players[currentUser.uid];

        Object.entries(roomData.players).forEach(([pid, p]) => {
            const el = document.createElement('div');
            el.className = 'p-2 rounded-lg mb-2 flex justify-between items-center transition-all';
            
            const isMe = pid === currentUser.uid;
            const isAlive = p.isAlive;
            const isDev = p.isDeveloper;
            const displayName = isDev ? p.nickname.substring(DEV_PREFIX.length).trim() : p.nickname;
            
            let statusIndicator = isAlive ? 'üü¢' : 'üëª';
            let roleIndicator = '';
            
            const roleEmojis = {werewolf:'üê∫', seer:'üëÅÔ∏è', doctor:'üßë‚Äç‚öïÔ∏è', hunter: 'üéØ', villager:'üë±'};
            if (myData.role === 'werewolf' && p.role === 'werewolf') roleIndicator = roleEmojis.werewolf;
            if (isMe) roleIndicator = roleEmojis[p.role];
            if (currentUser.isDeveloper) roleIndicator = roleEmojis[p.role];

            let nickHTML = `<span class="font-bold">${displayName}</span>`;
            if (isDev) nickHTML += ` <span class="shimmer-tag ml-2">Developer</span>`;

            el.innerHTML = `<div><span class="mr-2">${statusIndicator}</span><span>${nickHTML} ${roleIndicator}</span></div>`;
            
            if (!isAlive) el.style.opacity = '0.5';
            if (isMe) el.style.background = 'rgba(255,255,255,0.05)';
            
            list.appendChild(el);
        });
        
        document.getElementById('developer-panel').classList.toggle('hidden', !currentUser.isDeveloper);
    }
    
    function renderGameOver(roomData) {
        const { winningTeam, reason, players } = roomData.gameOver;
        document.getElementById('game-over-title').textContent = `${winningTeam} Win!`;
        document.getElementById('game-over-reason').textContent = reason;
        
        const rolesList = document.getElementById('game-over-roles');
        rolesList.innerHTML = '<h4>Final Roles:</h4>';
        Object.values(players).forEach(p => {
            const displayName = p.isDeveloper ? p.nickname.substring(DEV_PREFIX.length).trim() : p.nickname;
            const roleEmoji = {werewolf:'üê∫', seer:'üëÅÔ∏è', doctor:'üßë‚Äç‚öïÔ∏è', hunter:'üéØ', villager:'üë±'}[p.role] || '‚ùì';
            rolesList.innerHTML += `<p>${roleEmoji} ${displayName} was a ${p.role}</p>`;
        });
        
        showModal('game-over-modal', true);
    }

    async function performNightAction(targetId, actionType) {
        const myData = localGameState.players[currentUser.uid];
        if (myData.role === 'seer' || (currentUser.isDeveloper && actionType === 'seer')) {
            const targetPlayer = localGameState.players[targetId];
            document.getElementById('seer-result-body').textContent = `${targetPlayer.nickname} is a ${targetPlayer.role}.`;
            showModal('seer-result-modal', true);
        }

        showToast('Action registered.');
        const roomRef = doc(db, 'rooms', currentRoomId);
        const action = currentUser.isDeveloper ? { target: targetId, type: actionType } : targetId;
        await updateDoc(roomRef, { [`players.${currentUser.uid}.actionTarget`]: action });
    }

    async function voteForPlayer(targetId) {
        showToast('Vote cast.');
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, { [`players.${currentUser.uid}.votedFor`]: targetId });
    }
    
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        
        const myData = {
            nickname: currentUser.displayName,
            isDeveloper: currentUser.isDeveloper
        };
        
        const chatRef = collection(db, 'rooms', currentRoomId, 'messages');
        await addDoc(chatRef, {
            uid: currentUser.uid,
            nickname: myData.nickname,
            isDeveloper: myData.isDeveloper,
            text: text,
            timestamp: serverTimestamp()
        });
        input.value = '';
    }
    
    async function dev_togglePlayerAlive(pid, shouldBeAlive) {
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, { [`players.${pid}.isAlive`]: shouldBeAlive });
    }
    
    function updateTimer(endTime) {
        if (gameTimerInterval) clearInterval(gameTimerInterval);
        const timerEl = document.getElementById('game-timer');

        if (!endTime || !endTime.seconds) {
            timerEl.textContent = '--:--';
            return;
        }

        gameTimerInterval = setInterval(() => {
            const now = Date.now();
            const end = endTime.seconds * 1000;
            const remaining = Math.max(0, Math.round((end - now) / 1000));
            
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (remaining <= 0) clearInterval(gameTimerInterval);
        }, 1000);
    }

    // Make functions globally accessible for onclick attributes
    window.performNightAction = performNightAction;
    window.voteForPlayer = voteForPlayer;
    window.dev_togglePlayerAlive = dev_togglePlayerAlive;

    // ---------- Event Listeners ----------
    document.getElementById('btn-create-room').addEventListener('click', createRoom);
    document.getElementById('btn-join').addEventListener('click', ()=>{
      const code = document.getElementById('join-code').value.trim().toUpperCase();
      if(!code){ showToast('Enter a room code', true); return; }
      joinRoom(code);
    });
    document.getElementById('btn-leave').addEventListener('click', leaveRoom);
    document.querySelectorAll('.setting-input').forEach(input => input.addEventListener('change', updateSettingsInDb));
    document.getElementById('btn-start').addEventListener('click', startGame);
    document.getElementById('btn-close-role-reveal').addEventListener('click', async () => {
        showModal('role-reveal-modal', false);
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, { [`players.${currentUser.uid}.ready`]: true });
    });
    document.getElementById('btn-back-to-lobby').addEventListener('click', async () => {
        showModal('game-over-modal', false);
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, { state: 'lobby' });
    });
    document.getElementById('chat-send').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('dev-end-game').addEventListener('click', async () => {
        if (confirm("Are you sure you want to end the game?")) {
            const roomRef = doc(db, 'rooms', currentRoomId);
            const roomData = (await getDoc(roomRef)).data();
            await updateDoc(roomRef, { 
                state: 'game_over',
                gameOver: { winningTeam: "Nobody", reason: "Game ended by a Developer.", players: roomData.players }
            });
        }
    });

    const rulesModal = document.getElementById('rules-modal-backdrop');
    document.getElementById('btn-how-to-play').addEventListener('click', () => showModal('rules-modal-backdrop', true));
    document.getElementById('btn-close-rules').addEventListener('click', () => showModal('rules-modal-backdrop', false));

    // ---------- Initialization ----------
    (function init(){
      initializeFirebase();
      const params = new URLSearchParams(location.search);
      const roomCode = params.get('room');
      if (roomCode) {
        document.getElementById('join-code').value = roomCode.toUpperCase();
      }
    })();
  </script>
</body>
</html>
